<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="í•œêµ­ë†ì–´ì´Œê³µì‚¬ ê¸€ë¡œë²Œì‚¬ì—…ì²˜ í•´ì™¸ì‚¬ì—…ê´€ë¦¬ì‹œìŠ¤í…œ - GIS ì§€ë„">
    <title>GIS ì§€ë„ | GBMS</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <!-- Leaflet CSS - ë¡œì»¬ ê²½ë¡œ ì‚¬ìš© (ë‚´ë¶€ë§ í™˜ê²½) -->
    <link rel="stylesheet" href="lib/leaflet/leaflet.css" />
    <style>
        /* GIS í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .gis-container {
            height: calc(100vh - 60px);
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
            background-color: #f8fafb; /* ì§€ë„ ë°°ê²½ìƒ‰ (íƒ€ì¼ì´ ì—†ì„ ë•Œ) */
            min-height: 400px; /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
        }
        
        /* ì§€ë„ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ë•Œ í‘œì‹œí•  ë©”ì‹œì§€ */
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            text-align: center;
        }
        
        .map-loading.hidden {
            display: none;
        }
        
        /* ì§€ë„ ë°°ê²½ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ (íƒ€ì¼ì´ ì—†ì„ ë•Œ) */
        .map-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.3;
            z-index: 0;
            pointer-events: none;
        }
        
        /* í•„í„° íŒ¨ë„ */
        .gis-filter-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            min-width: 280px;
            max-width: 350px;
        }
        
        .gis-filter-panel h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #0A3D62;
        }
        
        .filter-group {
            margin-bottom: 12px;
        }
        
        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 6px;
        }
        
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .filter-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .filter-checkbox label {
            font-size: 13px;
            font-weight: normal;
            cursor: pointer;
            margin: 0;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
        }
        
        /* ë²”ë¡€ */
        .gis-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid;
        }
        
        .legend-dot.consulting {
            border-color: #0A3D62;
            background: rgba(10, 61, 98, 0.2);
        }
        
        .legend-dot.oda {
            border-color: #E65100;
            background: rgba(230, 81, 0, 0.2);
        }
        
        /* íŒì—… ìŠ¤íƒ€ì¼ */
        .leaflet-popup-content-wrapper {
            border-radius: 12px !important;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2) !important;
        }
        
        .leaflet-popup.consulting-popup .leaflet-popup-content-wrapper {
            border: 3px solid #0A3D62 !important;
        }
        
        .leaflet-popup.oda-popup .leaflet-popup-content-wrapper {
            border: 3px solid #E65100 !important;
        }
        
        .popup-content {
            min-width: 200px;
        }
        
        .popup-title {
            font-weight: 700;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .popup-info {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .popup-budget {
            font-weight: 600;
            color: #28a745;
            margin-top: 8px;
        }
        
        /* ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
        .custom-div-icon {
            background: transparent !important;
            border: none !important;
        }
        
        .marker-with-label {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .marker-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }
        
        .marker-circle.consulting {
            border-color: #0A3D62;
            background: rgba(10, 61, 98, 0.3);
        }
        
        .marker-circle.oda {
            border-color: #E65100;
            background: rgba(230, 81, 0, 0.3);
        }
        
        .marker-label {
            margin-top: 4px;
            font-size: 11px;
            font-weight: 700;
            color: #2c3e50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            .gis-filter-panel {
                top: 60px;
                left: 10px;
                right: 10px;
                min-width: auto;
                max-width: none;
            }
            
            .gis-legend {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">ğŸŒ</div>
                <span class="sidebar-title">GBMS</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ë©”ì¸</div>
                    <a href="dashboard.html" class="nav-item">
                        <span class="nav-icon">ğŸ“Š</span>
                        <span class="nav-text">ëŒ€ì‹œë³´ë“œ</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">ì‚¬ì—…ê´€ë¦¬</div>
                    <a href="consulting.html" class="nav-item">
                        <span class="nav-icon">ğŸ”§</span>
                        <span class="nav-text">í•´ì™¸ê¸°ìˆ ìš©ì—­</span>
                    </a>
                    <a href="pages/projects/oda.html" class="nav-item">
                        <span class="nav-icon">ğŸ¤</span>
                        <span class="nav-text">êµ­ì œë†ì—…í˜‘ë ¥(ODA)</span>
                    </a>
                    <a href="pages/projects/investment.html" class="nav-item">
                        <span class="nav-icon">ğŸŒ±</span>
                        <span class="nav-text">í•´ì™¸ë†ì—…íˆ¬ì</span>
                    </a>
                    <a href="pages/projects/loan.html" class="nav-item">
                        <span class="nav-icon">ğŸ’³</span>
                        <span class="nav-text">ìœµìÂ·ë³´ì¡°ì‚¬ì—…</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">GIS</div>
                    <a href="gis.html" class="nav-item active">
                        <span class="nav-icon">ğŸ—ºï¸</span>
                        <span class="nav-text">GIS ì§€ë„</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">ê´€ë¦¬</div>
                    <a href="pages/budget/index.html" class="nav-item">
                        <span class="nav-icon">ğŸ’°</span>
                        <span class="nav-text">ì˜ˆì‚°/ì •ì‚°</span>
                    </a>
                    <a href="pages/documents/index.html" class="nav-item">
                        <span class="nav-icon">ğŸ“„</span>
                        <span class="nav-text">ë¬¸ì„œê´€ë¦¬</span>
                    </a>
                    <a href="pages/offices/index.html" class="nav-item">
                        <span class="nav-icon">ğŸ¢</span>
                        <span class="nav-text">í•´ì™¸ì‚¬ë¬´ì†Œ</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="sidebar-toggle-btn" id="sidebarToggle">
                    <span>â—€</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="header-toggle" id="headerToggle">
                        <span>â˜°</span>
                    </button>
                    <h1 class="header-title">GIS ì§€ë„</h1>
                </div>
                <div class="header-right">
                    <div class="header-user dropdown" id="userDropdown">
                        <div class="user-avatar" id="userAvatar">ê´€</div>
                        <div class="user-info">
                            <span class="user-name" id="userName">ê´€ë¦¬ì</span>
                            <span class="user-role" id="userDept">ê¸€ë¡œë²Œë†ì—…ê°œë°œë¶€</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- GIS Map Container -->
            <div class="gis-container">
                <!-- ë¡œë”© ë©”ì‹œì§€ -->
                <div class="map-loading" id="mapLoading">
                    <div style="margin-bottom: 10px;">ğŸ—ºï¸</div>
                    <div>ì§€ë„ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
                </div>
                <!-- ë°°ê²½ ì´ë¯¸ì§€ (íƒ€ì¼ì´ ì—†ì„ ë•Œ í‘œì‹œ, ì„ íƒì‚¬í•­) -->
                <img src="images/world-map-background.png" alt="World Map" class="map-background-image" id="mapBackground" style="display: none;" onerror="this.style.display='none';">
                <div id="map"></div>
                
                <!-- Filter Panel -->
                <div class="gis-filter-panel">
                    <h3>í•„í„°</h3>
                    <input type="text" id="searchInput" class="search-input" placeholder="ì‚¬ì—…ëª…, êµ­ê°€ ê²€ìƒ‰...">
                    
                    <div class="filter-group">
                        <label>ì¹´í…Œê³ ë¦¬</label>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterConsulting" checked>
                            <label for="filterConsulting">í•´ì™¸ê¸°ìˆ ìš©ì—­</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterODA" checked>
                            <label for="filterODA">ODA</label>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>ìƒíƒœ</label>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterPlanning" checked>
                            <label for="filterPlanning">ê¸°íš</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterInProgress" checked>
                            <label for="filterInProgress">ì§„í–‰ì¤‘</label>
                        </div>
                        <div class="filter-checkbox">
                            <input type="checkbox" id="filterCompleted" checked>
                            <label for="filterCompleted">ì™„ë£Œ</label>
                        </div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="gis-legend">
                    <div class="legend-item">
                        <div class="legend-dot consulting"></div>
                        <span>í•´ì™¸ê¸°ìˆ ìš©ì—­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot oda"></div>
                        <span>ODA</span>
                    </div>
                </div>
                
                <!-- ì§€ë„ ìŠ¤íƒ€ì¼ ì„ íƒ (ì˜µì…˜) -->
                <div class="map-style-selector" style="position: absolute; top: 80px; right: 20px; z-index: 1000; background: white; border-radius: 8px; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: none;">
                    <label style="font-size: 12px; font-weight: 600; color: #495057; margin-bottom: 4px; display: block;">ì§€ë„ ìŠ¤íƒ€ì¼</label>
                    <select id="mapStyleSelect" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        <option value="m">ì¼ë°˜ ì§€ë„ (ì¢…ì´ ì§€ë„)</option>
                        <option value="t">ì§€í˜•ë„</option>
                        <option value="s">ìœ„ì„± ì§€ë„</option>
                        <option value="y">í•˜ì´ë¸Œë¦¬ë“œ</option>
                    </select>
                </div>
            </div>
        </main>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <!-- Leaflet JS - ë¡œì»¬ ê²½ë¡œ ì‚¬ìš© (ë‚´ë¶€ë§ í™˜ê²½) -->
    <script src="lib/leaflet/leaflet.js"></script>
    <script>
        // GIS ì§€ë„ ì´ˆê¸°í™”
        let map = null;
        let markersLayer = null;
        let allProjects = [];
        let filteredProjects = [];
        let currentTileLayer = null; // í˜„ì¬ íƒ€ì¼ ë ˆì´ì–´
        
        // êµ­ê°€ ì½”ë“œ ë§¤í•‘
        const countryCodeMap = {
            "ë² íŠ¸ë‚¨": "vn", "ë¼ì˜¤ìŠ¤": "la", "ìº„ë³´ë””ì•„": "kh", "í•„ë¦¬í•€": "ph", "ëª½ê³¨": "mn",
            "ìš°ì¦ˆë² í‚¤ìŠ¤íƒ„": "uz", "í‚¤ë¥´ê¸°ìŠ¤ìŠ¤íƒ„": "kg", "ìŠ¤ë¦¬ë‘ì¹´": "lk", "ë¯¸ì–€ë§ˆ": "mm",
            "ë°©ê¸€ë¼ë°ì‹œ": "bd", "íƒœêµ­": "th", "ì¸ë„ë„¤ì‹œì•„": "id", "ì¸ë„": "in", "ë„¤íŒ”": "np",
            "ì•„í”„ê°€ë‹ˆìŠ¤íƒ„": "af", "ì´ë€": "ir", "ê°€ë‚˜": "gh", "ì¼€ëƒ": "ke", "íƒ„ìë‹ˆì•„": "tz",
            "ì„¸ë„¤ê°ˆ": "sn", "ìš°ê°„ë‹¤": "ug", "ì¹´ë©”ë£¬": "cm", "ëª¨ì ë¹„í¬": "mz", "ì—í‹°ì˜¤í”¼ì•„": "et",
            "ë§ë¼ìœ„": "mw", "ì•™ê³¨ë¼": "ao", "ê°ë¹„ì•„": "gm", "ê¸°ë‹ˆ": "gn", "DRì½©ê³ ": "cd",
            "ì½©ê³ ë¯¼ì£¼ê³µí™”êµ­": "cd", "ì½”íŠ¸ë””ë¸Œì•„ë¥´": "ci", "ë³¼ë¦¬ë¹„ì•„": "bo", "ì—˜ì‚´ë°”ë„ë¥´": "sv",
            "í˜ë£¨": "pe", "í‚¤ë¦¬ë°”ì‹œ": "ki", "í•œêµ­": "kr", "ì¼ë³¸": "jp", "ì¤‘êµ­": "cn",
            "ëŸ¬ì‹œì•„": "ru", "ë¯¸êµ­": "us", "ìš”ë¥´ë‹¨": "jo", "ì•Œì œë¦¬": "dz", "íŒŒë¼ê³¼ì´": "py",
            "ë§ë ˆì´ì‹œì•„": "my", "ë¸Œë£¨ë‚˜ì´": "bn", "ê³¼í…Œë§ë¼": "gt", "íŒŒí‚¤ìŠ¤íƒ„": "pk",
            "ì•„ë¥´í—¨í‹°ë‚˜": "ar"
        };
        
        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            // ì§€ë„ ì»¨í…Œì´ë„ˆ í™•ì¸
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('ì§€ë„ ì»¨í…Œì´ë„ˆ(#map)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ì§€ë„ ì»¨í…Œì´ë„ˆ í™•ì¸ ì™„ë£Œ');
            
            try {
                map = L.map('map', {
                    center: [20, 0],
                    zoom: 3,
                    zoomControl: true
                });
                
                console.log('Leaflet ì§€ë„ ê°ì²´ ìƒì„± ì™„ë£Œ');
            } catch (error) {
                console.error('ì§€ë„ ìƒì„± ì‹¤íŒ¨:', error);
                alert('ì§€ë„ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
                return;
            }
            
            // íƒ€ì¼ ë ˆì´ì–´ ì„¤ì • - êµ¬ê¸€ ì§€ë„ XYZ íƒ€ì¼ ì‚¬ìš©
            // 1ìˆœìœ„: êµ¬ê¸€ ì§€ë„ íƒ€ì¼ (ì¢…ì´ ì§€ë„ ëŠë‚Œ)
            // 2ìˆœìœ„: ë¡œì»¬ íƒ€ì¼ (ë‚´ë¶€ë§ í™˜ê²½)
            // 3ìˆœìœ„: ë°°ê²½ ì´ë¯¸ì§€ ë˜ëŠ” ê·¸ë¦¬ë“œ
            
            let tileLayerAdded = false;
            
            // êµ¬ê¸€ ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ (ì¼ë°˜ ì§€ë„ - ì¢…ì´ ì§€ë„ ëŠë‚Œ)
            // lyrs=m: ì¼ë°˜ ì§€ë„ (Map)
            // lyrs=t: ì§€í˜•ë„ (Terrain)
            // lyrs=s: ìœ„ì„± ì§€ë„ (Satellite)
            // lyrs=y: í•˜ì´ë¸Œë¦¬ë“œ (Hybrid)
            try {
                const googleMapLayer = L.tileLayer('https://mt{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                    attribution: 'Â© Google Maps',
                    maxZoom: 20,
                    subdomains: ['0', '1', '2', '3'],
                    tileSize: 256,
                    zoomOffset: 0
                });
                
                // íƒ€ì¼ ë¡œë“œ ì„±ê³µ/ì‹¤íŒ¨ í™•ì¸
                googleMapLayer.on('tileerror', function(error, tile) {
                    console.warn('êµ¬ê¸€ ì§€ë„ íƒ€ì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                    if (!tileLayerAdded) {
                        tryLocalTile();
                    }
                });
                
                googleMapLayer.on('tileload', function() {
                    tileLayerAdded = true;
                });
                
                googleMapLayer.addTo(map);
                currentTileLayer = googleMapLayer;
                
                // íƒ€ì„ì•„ì›ƒ ì„¤ì •: 3ì´ˆ ë‚´ íƒ€ì¼ì´ ë¡œë“œë˜ì§€ ì•Šìœ¼ë©´ ëŒ€ì²´ ë°©ë²• ì‹œë„
                setTimeout(function() {
                    if (!tileLayerAdded) {
                        console.info('êµ¬ê¸€ ì§€ë„ íƒ€ì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë‚´ë¶€ë§ í™˜ê²½ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
                        console.info('ëŒ€ì²´ ë°©ë²•ì„ ì‹œë„í•©ë‹ˆë‹¤.');
                        tryLocalTile();
                    } else {
                        console.info('êµ¬ê¸€ ì§€ë„ íƒ€ì¼ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                }, 3000);
                
            } catch (e) {
                console.warn('êµ¬ê¸€ ì§€ë„ íƒ€ì¼ ë ˆì´ì–´ ìƒì„± ì‹¤íŒ¨:', e);
                tryLocalTile();
            }
            
            // ë¡œì»¬ íƒ€ì¼ ì‹œë„
            function tryLocalTile() {
                if (tileLayerAdded) return;
                
                try {
                    const localTileLayer = L.tileLayer('lib/leaflet/tiles/{z}/{x}/{y}.png', {
                        attribution: 'Â© GBMS',
                        maxZoom: 18,
                        errorTileUrl: null
                    });
                    
                    localTileLayer.on('tileerror', function() {
                        if (!tileLayerAdded) {
                            addDefaultTileLayer();
                        }
                    });
                    
                    localTileLayer.on('tileload', function() {
                        tileLayerAdded = true;
                    });
                    
                    localTileLayer.addTo(map);
                    
                    setTimeout(function() {
                        if (!tileLayerAdded) {
                            addDefaultTileLayer();
                        }
                    }, 2000);
                    
                } catch (e) {
                    console.log('ë¡œì»¬ íƒ€ì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    addDefaultTileLayer();
                }
            }
            
            // ê¸°ë³¸ ë°°ê²½ ì¶”ê°€ (íƒ€ì¼ì´ ëª¨ë‘ ì‹¤íŒ¨í•œ ê²½ìš°)
            // ì¦‰ì‹œ ê¸°ë³¸ ë°°ê²½ ì¶”ê°€ (íƒ€ì¼ì´ ë¡œë“œë˜ë©´ ë®ì–´ì”€)
            setTimeout(function() {
                if (!tileLayerAdded) {
                    console.info('íƒ€ì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ë³¸ ë°°ê²½ì„ í‘œì‹œí•©ë‹ˆë‹¤.');
                    addDefaultTileLayer();
                }
            }, 1000);
            
            markersLayer = L.layerGroup().addTo(map);
            console.log('ë§ˆì»¤ ë ˆì´ì–´ ìƒì„± ì™„ë£Œ');
        }
        
        // ê¸°ë³¸ íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€ (ë°°ê²½ ì´ë¯¸ì§€ ë˜ëŠ” ê·¸ë¦¬ë“œ)
        function addDefaultTileLayer() {
            if (!map) {
                console.error('ì§€ë„ ê°ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë°°ê²½ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            const bgImage = document.getElementById('mapBackground');
            if (bgImage) {
                // ì´ë¯¸ì§€ê°€ ì´ë¯¸ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (bgImage.complete && bgImage.naturalWidth > 0) {
                    bgImage.style.display = 'block';
                    console.info('ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    return;
                }
                
                // ì´ë¯¸ì§€ ë¡œë“œ ì´ë²¤íŠ¸
                bgImage.onload = function() {
                    this.style.display = 'block';
                    console.info('ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                };
                
                bgImage.onerror = function() {
                    console.info('ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ë¦¬ë“œ ë°°ê²½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    addGridBackground();
                };
                
                // ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„ (ì´ë¯¸ srcê°€ ìˆìœ¼ë©´ ìë™ ë¡œë“œë¨)
                if (!bgImage.src || bgImage.src === window.location.href) {
                    bgImage.src = 'images/world-map-background.png';
                }
            } else {
                console.info('ë°°ê²½ ì´ë¯¸ì§€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê·¸ë¦¬ë“œ ë°°ê²½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                addGridBackground();
            }
        }
        
        // ê·¸ë¦¬ë“œ ë°°ê²½ ì¶”ê°€
        function addGridBackground() {
            if (!map) {
                console.error('ì§€ë„ ê°ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const gridBackground = L.tileLayer('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0iZ3JpZCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIj48cGF0aCBkPSJNIDIwIDAgTCAwIDAgMCAyMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTBlNGU4IiBzdHJva2Utd2lkdGg9IjAuNSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiIGZpbGw9IiNmOGZhZmIiLz48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0idXJsKCNncmlkKSIvPjwvc3ZnPg==', {
                    attribution: 'Â© GBMS',
                    maxZoom: 18,
                    tileSize: 256,
                    zoomOffset: 0
                });
                gridBackground.addTo(map);
                console.info('ê·¸ë¦¬ë“œ ë°°ê²½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            } catch (error) {
                console.error('ê·¸ë¦¬ë“œ ë°°ê²½ ìƒì„± ì‹¤íŒ¨:', error);
            }
        }
        
        // í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ
        async function loadProjects() {
            try {
                console.log('í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                const response = await API.get('/gis/projects');
                console.log('API ì‘ë‹µ:', response);
                
                if (response.success) {
                    console.log('ë°›ì€ í”„ë¡œì íŠ¸ ìˆ˜:', response.data.length);
                    
                    // ë°±ì—”ë“œ API í˜•ì‹ì— ë§ê²Œ ë³€í™˜
                    allProjects = response.data.map(project => ({
                        ...project,
                        lat: project.latitude || project.lat,
                        lng: project.longitude || project.lng,
                        name: project.country || project.name,
                        description: project.title || project.description
                    }));
                    
                    console.log('ë³€í™˜ëœ í”„ë¡œì íŠ¸ ìˆ˜:', allProjects.length);
                    console.log('í”„ë¡œì íŠ¸ ìƒ˜í”Œ:', allProjects[0]);
                    
                    // ì¢Œí‘œê°€ ìˆëŠ” í”„ë¡œì íŠ¸ í™•ì¸
                    const withCoords = allProjects.filter(p => {
                        const lat = parseFloat(p.lat || p.latitude);
                        const lng = parseFloat(p.lng || p.longitude);
                        return lat && lng && !isNaN(lat) && !isNaN(lng);
                    });
                    console.log('ì¢Œí‘œê°€ ìˆëŠ” í”„ë¡œì íŠ¸ ìˆ˜:', withCoords.length);
                    
                    if (allProjects.length === 0) {
                        console.warn('í”„ë¡œì íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ì— ì¢Œí‘œ ì •ë³´ê°€ ìˆëŠ” í”„ë¡œì íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                    } else if (withCoords.length === 0) {
                        console.warn('ì¢Œí‘œ ì •ë³´ê°€ ìˆëŠ” í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ì— latitudeì™€ longitude ê°’ì„ ì¶”ê°€í•˜ì„¸ìš”.');
                    }
                    
                    applyFilters();
                } else {
                    console.error('API ì‘ë‹µ ì‹¤íŒ¨:', response);
                }
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', error.message, error.stack);
                if (Utils && Utils.showNotification) {
                    Utils.showNotification('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message, 'error');
                } else {
                    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }
        
        // ë§ˆì»¤ ìƒì„±
        function createMarker(project) {
            const category = project.category || 'Consulting';
            const color = category === 'ODA' ? '#E65100' : '#0A3D62';
            const lat = parseFloat(project.lat || project.latitude);
            const lng = parseFloat(project.lng || project.longitude);
            
            // ì¢Œí‘œ ìœ íš¨ì„± ê²€ì‚¬
            if (!lat || !lng || isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                console.debug('ìœ íš¨í•˜ì§€ ì•Šì€ ì¢Œí‘œ:', { lat, lng, project: project.title || project.description });
                return null;
            }
            
            // ì¢Œí‘œ ë²”ìœ„ ê²€ì‚¬ (ìœ„ë„: -90 ~ 90, ê²½ë„: -180 ~ 180)
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                console.warn('ì¢Œí‘œ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨:', { lat, lng, project: project.title || project.description });
                return null;
            }
            
            const iconHtml = `
                <div class="marker-with-label">
                    <div class="marker-circle ${category === 'ODA' ? 'oda' : 'consulting'}"></div>
                    <div class="marker-label">${(project.description || '').substring(0, 8)}</div>
                </div>
            `;
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'custom-div-icon',
                iconSize: [100, 40],
                iconAnchor: [50, 40],
                popupAnchor: [0, -40]
            });
            
            const marker = L.marker([lat, lng], { icon: customIcon });
            
            const title = project.description || project.title || 'ì‚¬ì—…ëª… ì—†ìŒ';
            const country = project.name || project.country || '';
            const period = project.period || (project.startDate && project.endDate ? 
                `${project.startDate.substring(0, 4)}-${project.endDate.substring(0, 4)}` : '');
            const budget = project.budget || project.budgetTotal || 0;
            const budgetText = budget > 0 ? 
                `${Math.round(budget / 100).toLocaleString()}ì–µì›` : '';
            
            const popupContent = `
                <div class="popup-content">
                    <div class="popup-title">${title}</div>
                    <div class="popup-info"><strong>êµ­ê°€:</strong> ${country}</div>
                    <div class="popup-info"><strong>ì¹´í…Œê³ ë¦¬:</strong> ${category}</div>
                    ${period ? `<div class="popup-info"><strong>ê¸°ê°„:</strong> ${period}</div>` : ''}
                    ${budgetText ? `<div class="popup-budget"><strong>ì˜ˆì‚°:</strong> ${budgetText}</div>` : ''}
                    ${project.client ? `<div class="popup-info"><strong>ë°œì£¼ì²˜:</strong> ${project.client}</div>` : ''}
                    ${project.code ? `<div class="popup-info"><strong>ì‚¬ì—…ì½”ë“œ:</strong> ${project.code}</div>` : ''}
                </div>
            `;
            
            const popupClassName = category === 'ODA' ? 'oda-popup' : 'consulting-popup';
            marker.bindPopup(popupContent, {
                className: popupClassName,
                maxWidth: 300
            });
            
            return marker;
        }
        
        // í•„í„° ì ìš©
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const showConsulting = document.getElementById('filterConsulting').checked;
            const showODA = document.getElementById('filterODA').checked;
            const showPlanning = document.getElementById('filterPlanning').checked;
            const showInProgress = document.getElementById('filterInProgress').checked;
            const showCompleted = document.getElementById('filterCompleted').checked;
            
            filteredProjects = allProjects.filter(project => {
                // ì¹´í…Œê³ ë¦¬ í•„í„°
                const category = project.category || 'Consulting';
                if (category === 'ODA' && !showODA) return false;
                if (category === 'Consulting' && !showConsulting) return false;
                
                // ê²€ìƒ‰ í•„í„°
                if (searchTerm) {
                    const searchable = [
                        project.description || '',
                        project.title || '',
                        project.name || '',
                        project.country || ''
                    ].join(' ').toLowerCase();
                    if (!searchable.includes(searchTerm)) return false;
                }
                
                // ìƒíƒœ í•„í„°
                const status = project.status || '';
                if (status === 'planning' && !showPlanning) return false;
                if (status === 'in_progress' && !showInProgress) return false;
                if (status === 'completed' && !showCompleted) return false;
                
                return true;
            });
            
            updateMarkers();
        }
        
        // ë§ˆì»¤ ì—…ë°ì´íŠ¸
        function updateMarkers() {
            if (!markersLayer) {
                console.error('ë§ˆì»¤ ë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ë§ˆì»¤ ì—…ë°ì´íŠ¸ ì‹œì‘...');
            console.log('í•„í„°ë§ëœ í”„ë¡œì íŠ¸ ìˆ˜:', filteredProjects.length);
            
            markersLayer.clearLayers();
            
            let markerCount = 0;
            filteredProjects.forEach((project, index) => {
                const marker = createMarker(project);
                if (marker) {
                    markersLayer.addLayer(marker);
                    markerCount++;
                } else {
                    console.warn(`í”„ë¡œì íŠ¸ ${index} ë§ˆì»¤ ìƒì„± ì‹¤íŒ¨:`, project);
                }
            });
            
            console.log('ìƒì„±ëœ ë§ˆì»¤ ìˆ˜:', markerCount);
            
            // ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (markerCount > 0) {
                const bounds = filteredProjects
                    .filter(p => {
                        const lat = parseFloat(p.lat || p.latitude);
                        const lng = parseFloat(p.lng || p.longitude);
                        return lat && lng && !isNaN(lat) && !isNaN(lng);
                    })
                    .map(p => {
                        const lat = parseFloat(p.lat || p.latitude);
                        const lng = parseFloat(p.lng || p.longitude);
                        return [lat, lng];
                    });
                
                if (bounds.length > 0) {
                    try {
                        const boundsObj = L.latLngBounds(bounds);
                        map.fitBounds(boundsObj, { padding: [50, 50], maxZoom: 10 });
                        console.log('ì§€ë„ ë²”ìœ„ ì¡°ì • ì™„ë£Œ:', boundsObj);
                    } catch (e) {
                        console.warn('ì§€ë„ ë²”ìœ„ ì¡°ì • ì‹¤íŒ¨:', e);
                    }
                }
            } else {
                console.warn('í‘œì‹œí•  ë§ˆì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì§€ë„ ìŠ¤íƒ€ì¼ ë³€ê²½
        function changeMapStyle(style) {
            if (!map) return;
            
            // ê¸°ì¡´ íƒ€ì¼ ë ˆì´ì–´ ì œê±°
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            // ìƒˆë¡œìš´ íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            const styleMap = {
                'm': 'ì¼ë°˜ ì§€ë„',
                't': 'ì§€í˜•ë„',
                's': 'ìœ„ì„± ì§€ë„',
                'y': 'í•˜ì´ë¸Œë¦¬ë“œ'
            };
            
            const googleMapLayer = L.tileLayer('https://mt{s}.google.com/vt/lyrs=' + style + '&x={x}&y={y}&z={z}', {
                attribution: 'Â© Google Maps',
                maxZoom: 20,
                subdomains: ['0', '1', '2', '3'],
                tileSize: 256,
                zoomOffset: 0
            });
            
            googleMapLayer.addTo(map);
            currentTileLayer = googleMapLayer;
            
            console.info('ì§€ë„ ìŠ¤íƒ€ì¼ ë³€ê²½: ' + styleMap[style]);
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('filterConsulting').addEventListener('change', applyFilters);
        document.getElementById('filterODA').addEventListener('change', applyFilters);
        document.getElementById('filterPlanning').addEventListener('change', applyFilters);
        document.getElementById('filterInProgress').addEventListener('change', applyFilters);
        document.getElementById('filterCompleted').addEventListener('change', applyFilters);
        
        // ì§€ë„ ìŠ¤íƒ€ì¼ ì„ íƒ ì´ë²¤íŠ¸
        const mapStyleSelect = document.getElementById('mapStyleSelect');
        if (mapStyleSelect) {
            mapStyleSelect.addEventListener('change', function(e) {
                changeMapStyle(e.target.value);
            });
        }
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            // Leaflet ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° (ìµœëŒ€ 5ì´ˆ)
            let leafletLoaded = false;
            let waitCount = 0;
            const maxWait = 50; // 5ì´ˆ (100ms * 50)
            
            while (typeof L === 'undefined' && waitCount < maxWait) {
                await new Promise(resolve => setTimeout(resolve, 100));
                waitCount++;
            }
            
            // Leaflet ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
            if (typeof L === 'undefined') {
                console.error('Leaflet ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.error('í•´ê²° ë°©ë²•:');
                console.error('1. lib/leaflet/leaflet.js íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸');
                console.error('2. LEAFLET_DOWNLOAD_GUIDE.md íŒŒì¼ ì°¸ê³ í•˜ì—¬ ë‹¤ìš´ë¡œë“œ');
                console.error('3. ë˜ëŠ” ì¸í„°ë„·ì´ ì—°ê²°ëœ ê²½ìš° CDNì—ì„œ ìë™ ë¡œë“œë¨');
                
                const loadingMsg = document.getElementById('mapLoading');
                if (loadingMsg) {
                    loadingMsg.innerHTML = `
                        <div style="margin-bottom: 10px;">âš ï¸</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">Leaflet ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div style="font-size: 12px; color: #666; text-align: left; max-width: 300px;">
                            <p style="margin: 5px 0;">í•„ìš”í•œ íŒŒì¼:</p>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li>lib/leaflet/leaflet.css</li>
                                <li>lib/leaflet/leaflet.js</li>
                            </ul>
                            <p style="margin: 10px 0 5px 0;">í•´ê²° ë°©ë²•:</p>
                            <p style="margin: 5px 0;">LEAFLET_DOWNLOAD_GUIDE.md íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.</p>
                        </div>
                    `;
                }
                return;
            }
            
                console.log('Leaflet ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
            
            // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
            const loadingMsg = document.getElementById('mapLoading');
            
            try {
                // App ì´ˆê¸°í™”ëŠ” ê±´ë„ˆë›°ê¸° (GIS í˜ì´ì§€ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì‘ë™)
                // ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ App.init() í˜¸ì¶œ
                // if (typeof App !== 'undefined' && App.init) {
                //     App.init();
                // }
                
                // ì§€ë„ ì´ˆê¸°í™”
                console.log('ì§€ë„ ì´ˆê¸°í™” ì‹œì‘...');
                initMap();
                
                // ì§€ë„ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (map) {
                    console.log('ì§€ë„ ìƒì„± ì„±ê³µ');
                    if (loadingMsg) loadingMsg.classList.add('hidden');
                } else {
                    console.error('ì§€ë„ ìƒì„± ì‹¤íŒ¨');
                    if (loadingMsg) {
                        loadingMsg.innerHTML = '<div style="margin-bottom: 10px;">âš ï¸</div><div>ì§€ë„ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div><div style="font-size: 12px; margin-top: 10px; color: #666;">ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</div>';
                    }
                }
                
                // í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ
                console.log('í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                await loadProjects();
                
                console.log('GIS ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                if (loadingMsg) {
                    loadingMsg.innerHTML = '<div style="margin-bottom: 10px;">âŒ</div><div>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div><div style="font-size: 12px; margin-top: 10px; color: #666;">' + error.message + '</div>';
                }
            }
        });
    </script>
</body>
</html>

